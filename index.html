<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>מועדון חבריםות – בדיקת חברות</title>
    <script src="https://www.gstatic.com/firebasejs/7.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/7.10.0/firebase-firestore.js"></script>
    <script>
      const currentUrl = new URL(window.location.href);
      const key = currentUrl.searchParams.get("key");

      firebase.initializeApp({
        apiKey: "AIzaSyB_fQwG_Ob9eA9ctlYNgRsZu1PejQ_nYg4",
        authDomain: "maavarimsfriends.firebaseapp.com",
        projectId: "maavarimsfriends"
      });

      const db = firebase.firestore();
    </script>
  </head>
  <body>
    <div id="subscription">Loading...</div>
    <script>
      function updateActiveSubscription(name) {
        document.getElementById(
          "subscription"
        ).innerText = `רישום בתוקף עבור ${name}.`;
      }

      function updateInactiveSubscription() {
        document.getElementById(
          "subscription"
        ).innerText = `הרישום אינו בתוקף. אנא חדשו אותו :)`;
      }

      function updateNoSubscription() {
        document.getElementById(
          "subscription"
        ).innerText = `לא נמצא רישום מתאים. אנא פנו לתמיכה`;
      }

      function updateError() {
        document.getElementById(
          "subscription"
        ).innerText = `חלה שגיאה בבדיקת המינוי, אנא נסו שנית`;
      }

      function updateStatus(key) {
        db.collection("members")
          .doc(key)
          .get()
          .then(doc => {
            if (doc.exists) {
              const { name, isActive } = doc.data();
              if (isActive === true || isActive === undefined) {
                updateActiveSubscription(name);
              } else {
                updateInactiveSubscription();
              }
            } else {
              updateNoSubscription();
            }
          })
          .catch(error => {
            updateError();
          });
      }

      if (key) updateStatus(key);
      else updateError();
    </script>
  </body>
</html>

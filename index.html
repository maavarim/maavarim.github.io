<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>מועדון חבריםות – בדיקת חברות</title>
    <script src="https://www.gstatic.com/firebasejs/7.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/7.10.0/firebase-firestore.js"></script>
    <link
      href="https://fonts.googleapis.com/css?family=Assistant:400,600&display=swap&subset=hebrew"
      rel="stylesheet"
    />

    <script>
      const currentUrl = new URL(window.location.href);
      const key = currentUrl.searchParams.get("key");

      function hideLoading() {
        document.getElementById("loading").style.display = "none";
      }

      function updateActiveSubscription(name) {
        document.getElementById("name").innerText = name;
        document.getElementById("success").style.display = "flex";
      }

      function updateInactiveSubscription() {
        document.getElementById(
          "error--message"
        ).innerText = `הרישום אינו בתוקף. אנא חדשו אותו :)`;
        document.getElementById("error").style.display = "flex";
      }

      function updateNoSubscription() {
        document.getElementById(
          "error--message"
        ).innerText = `לא נמצא רישום מתאים. אנא פנו לתמיכה`;
        document.getElementById("error").style.display = "flex";
      }

      function updateError() {
        document.getElementById(
          "error--message"
        ).innerText = `חלה שגיאה בבדיקת המינוי, אנא נסו שנית`;
        document.getElementById("error").style.display = "flex";
      }

      function updateStatus(key) {
        firebase.initializeApp({
          apiKey: "AIzaSyB_fQwG_Ob9eA9ctlYNgRsZu1PejQ_nYg4",
          authDomain: "maavarimsfriends.firebaseapp.com",
          projectId: "maavarimsfriends"
        });
        const db = firebase.firestore();
        db.collection("members")
          .doc(key)
          .get()
          .then(doc => {
            hideLoading();
            if (doc.exists) {
              const { name, isActive } = doc.data();
              if (isActive === true || isActive === undefined) {
                updateActiveSubscription(name);
              } else {
                updateInactiveSubscription();
              }
            } else {
              updateNoSubscription();
            }
          })
          .catch(error => {
            hideLoading();
            updateError();
          });
      }
    </script>
    <style>
      body {
        direction: rtl;
        font-family: "Assistant", sans-serif;
        font-size: 18px;
      }

      #name {
        display: inline;
        font-weight: 600;
      }

      .success,
      .error {
        display: none;
        flex-direction: column;
        align-items: center;
        min-height: 100vh;
        justify-content: center;
      }

      .success--icon {
        height: 2rem;
        width: 2rem;
        color: #4caf50;
        margin-bottom: 0.5rem;
      }

      .error--icon {
        height: 2rem;
        width: 2rem;
        color: #f44336;
        margin-bottom: 0.5rem;
      }
    </style>
  </head>
  <body>
    <div id="success" class="success">
      <svg class="success--icon" viewBox="0 0 24 24">
        <path
          fill="currentColor"
          d="M20,12A8,8 0 0,1 12,20A8,8 0 0,1 4,12A8,8 0 0,1 12,4C12.76,4 13.5,4.11 14.2,4.31L15.77,2.74C14.61,2.26 13.34,2 12,2A10,10 0 0,0 2,12A10,10 0 0,0 12,22A10,10 0 0,0 22,12M7.91,10.08L6.5,11.5L11,16L21,6L19.59,4.58L11,13.17L7.91,10.08Z"
        />
      </svg>
      <div class="success--message">
        המינוי בתוקף עבור
        <div id="name"></div>
        .
      </div>
    </div>
    <div id="error" class="error">
      <svg class="error--icon" viewBox="0 0 24 24">
        <path
          fill="currentColor"
          d="M12,20C7.59,20 4,16.41 4,12C4,7.59 7.59,4 12,4C16.41,4 20,7.59 20,12C20,16.41 16.41,20 12,20M12,2C6.47,2 2,6.47 2,12C2,17.53 6.47,22 12,22C17.53,22 22,17.53 22,12C22,6.47 17.53,2 12,2M14.59,8L12,10.59L9.41,8L8,9.41L10.59,12L8,14.59L9.41,16L12,13.41L14.59,16L16,14.59L13.41,12L16,9.41L14.59,8Z"
        />
      </svg>
      <div id="error--message"></div>
    </div>
    <div id="loading">Loading...</div>
    <script>
      if (key) updateStatus(key);
      else updateError();
    </script>
  </body>
</html>
